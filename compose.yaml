x-common-environment:
  environment:
    - ENV=${ENV:-dev}

# NOTE: Ports do not need to be exposed if not needed to expose outside the network

services:
  peerprep-dev:
    depends_on:
      - user-service-dev
      - backend-dev
    build:
      context: peerprep
      target: dev
    env_file:
      - peerprep/.env
    environment:
      - ENV=${ENV:-dev}
    volumes:
      - ./peerprep:/frontend
    ports:
      - "${PEERPREP_PORT:-3000}:3000"
    networks:
      - backend
      - user-service
      - matching
      ####### Dockerfile Node is distroless, no curl
      #    healthcheck:
      #      test: [ "CMD", "curl", "-f", "http://localhost:3000/" ]
    restart: on-failure
    develop:
      watch:
        - action: sync
          path: peerprep
          target: /frontend


  user-service-dev:
    #    profiles:
    #      - [ dev ]
    build:
      context: user-service
      target: dev
    depends_on:
      - mongo-dev
    env_file:
      - user-service/.env
    environment:
      - ENV=${ENV:-DEV}
    volumes:
      - ./user-service:/user-service
    ports:
      - "${USER_SERVICE_PORT:-3001}:3001"
    networks:
      - user-service
      - user-mongo
    ##### No curl on distroless node
    #    healthcheck:
    #      test: [ "CMD", "curl", "-f", "http://localhost:3001/" ]
    restart: on-failure
    develop:
      watch:
        - action: sync
          path: user-service
          target: /user-service


  #  user-service-prod:
  #    extends:
  #      service: user-service-dev
  #    profiles:
  #      - [ prod ]
  #    environment:
  #      - ENV=prod
  #    build:
  #      target: final

  backend-dev:
    #    profiles:
    #      - [ dev ]
    build:
      context: backend
      target: dev
    env_file:
      - backend/.env
    environment:
      - ENV=${ENV:-dev}
    volumes:
      - logs:/log
      - ./backend:/src
    ports:
      - "${BACKEND_PORT:-9090}:9090"
    networks:
      - backend
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:9090/health" ]
    restart: on-failure
    develop:
      watch:
        - action: rebuild
          path: backend
          target: backend/app


  #    backend-prod:
  #      extends:
  #        service: backend-prod
  #      profiles:
  #        - [ prod ]
  #      environment:
  #        - ENV=prod
  #      build:
  #        target: final

  mongo-dev:
    image: "mongo:latest"
    restart: on-failure
    volumes:
      - mongo-data:/data/db
    ports:
      - "27017:27017"
      - "${usermongoport:-27017}:27017"
    networks:
      - user-mongo


  # blob and mq
  redis:
    image: redis
    container_name: redis-peerprep
    ports:
      - "9190:6379"
    networks:
      - matching

  rabbitmq:
    image: rabbitmq:3-management
    container_name: rabbitmq
    environment:
      RABBITMQ_DEFAULT_USER: grp14
      RABBITMQ_DEFAULT_PASS: grp14
    ports:
      - "9100:5672"
      - "9101:15672"
    networks:
      - matching
    healthcheck:
      test: rabbitmq-diagnostics check_port_connectivity
      interval: 30s
      timeout: 30s
      retries: 10

  matching-service:
    build:
      context: matching-service
      target: dev
    env_file:
      - matching-service/.env
    networks:
      - matching
    volumes:
      - logs:/log
      - ./matching-service:/src
    develop:
      watch:
        - action: rebuild
          path: matching-service
          target: matching-service/app
    # TODO for some reason healthcheck doesnt really work, still have to manually start MS and MS-api
    depends_on:
      rabbitmq:
        condition: service_healthy

  matching-service-api:
    build:
      context: matching-service-api
      target: dev
    env_file:
      - matching-service-api/.env
    ports:
      - "9200:9200"
    volumes:
      - logs:/log
      - ./matching-service-api:/src
    networks:
      - matching
    develop:
      watch:
        - action: rebuild
          path: matching-service
          target: matching-service/app
    depends_on:
      rabbitmq:
        condition: service_healthy

  storage-blob-api:
    build:
      context: storage-blob-api
      target: dev
    env_file:
      - storage-blob-api/.env
    volumes:
      - logs:/log
      - ./storage-blob-api:/src
    ports:
      - "9300:9300"
    networks:
      - matching
    develop:
      watch:
        - action: rebuild
          path: storage-blob-api
          target: storage-blob-api/app
    depends_on:
      - redis



networks:
  backend:
    driver: bridge
  user-service:
    driver: bridge
  user-mongo:
    driver: bridge
  matching:
    driver: bridge

volumes:
  logs:
  mongo-data:
